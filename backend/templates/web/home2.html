{% extends "web/base.html" %}
{% load static %}

{% block title %}Inmuebles | Alquiler{% endblock %}
{% block content %}
<section class="container py-4">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <div>
      <h2 class="mb-0">Inmuebles</h2>
      <small class="text-muted">Encuentra tu próximo hogar</small>
    </div>
  </div>

  <form method="get" class="row g-2 mb-3 p-3 bg-light rounded-3 shadow-sm">
  <div class="col-md-3">
    <select name="tipo" class="form-select form-select-sm rounded-pill">
      <option value="">Tipo de inmueble</option>
      {% for value, label in tipos %}
        <option value="{{ value }}" {% if value == selected_tipo %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="region" class="form-select form-select-sm rounded-pill" id="region-select">
      <option value="">Región</option>
      {% for region in regiones %}
        <option value="{{ region.id }}" {% if region.id|stringformat:"s" == selected_region %}selected{% endif %}>
          {{ region.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <select name="comuna" class="form-select form-select-sm rounded-pill" id="comuna-select">
      <option value="">Comuna</option>
      {% for comuna in comunas %}
        <option value="{{ comuna.id }}" data-region="{{ comuna.region_id }}"
          {% if comuna.id|stringformat:"s" == selected_comuna %}selected{% endif %}>
          {{ comuna.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <button type="submit" class="btn btn-primary btn-sm w-100 rounded-pill">Filtrar</button>
  </div>

  <div class="col-md-1">
    <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm w-100 rounded-pill">Resetear</a>
  </div>
</form>

  {% if inmuebles %}
    <div class="row g-4">
      {% for i in inmuebles %}
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card shadow-soft h-100">
            <img
              src="{% if i.imagen %}{{ i.imagen.url }}{% else %}https://picsum.photos/600/400?random={{ forloop.counter }}{% endif %}"
              class="card-img-top object-fit-cover" style="height: 220px;" alt="Imagen de {{ i.nombre }}"
            >
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start">
                <h5 class="card-title mb-1">{{ i.nombre }}</h5>
                <span class="badge bg-light text-dark border">{{ i.get_tipo_de_inmueble_display }}</span>
              </div>
              <p class="text-muted small mb-2">{{ i.comuna.nombre }}</p>
              <p class="card-text mb-3">{{ i.descripcion|truncatewords:18 }}</p>
              <ul class="list-unstyled small mb-3 text-muted">
                <li>Construidos: <strong>{{ i.m2_construidos }} m²</strong></li>
                <li>Totales: <strong>{{ i.m2_totales }} m²</strong></li>
                <li>Hab: <strong>{{ i.habitaciones }}</strong> · Baños: <strong>{{ i.banos }}</strong> · Estac: <strong>{{ i.estacionamientos }}</strong></li>
              </ul>
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  {% load formato_clp %}
                  <span class="h5 text-success mb-0">${{ i.precio_mensual|clp }} / mes</span>
                </div>
                {% if user.is_authenticated %}
                  <a href="{% url 'solicitud_create_for_inmueble' i.id %}" class="btn btn-outline-primary w-100 btn-soft">
                    <i class="bi bi-envelope-paper me-1"></i> Solicitar Arriendo
                  </a>
                {% else %}
                  <button class="btn btn-outline-secondary w-100 btn-soft" data-bs-toggle="modal" data-bs-target="#loginModal">
                    <i class="bi bi-box-arrow-in-right me-1"></i> Inicia sesión para solicitar
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {% if is_paginated %}
  <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center">

      {# Botón Anterior #}
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link rounded-pill" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link rounded-pill">Anterior</span>
        </li>
      {% endif %}

      {# Mostrar máximo 5 páginas seguidas #}
      {% for num in page_obj.paginator.page_range %}
        {% if num <= 5 %}
          {% if num == page_obj.number %}
            <li class="page-item active">
              <span class="page-link rounded-pill">{{ num }}</span>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link rounded-pill" href="?page={{ num }}">{{ num }}</a>
            </li>
          {% endif %}
        {% endif %}
      {% endfor %}

      {# Botón Siguiente #}
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link rounded-pill" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link rounded-pill">Siguiente</span>
        </li>
      {% endif %}

    </ul>
  </nav>
    {% endif %}
  {% else %}
    <div class="alert alert-info shadow-soft">No hay inmuebles publicados.</div>
  {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const regionSelect = document.getElementById("region-select");
  const comunaSelect = document.getElementById("comuna-select");
  const allComunas = Array.from(comunaSelect.options);

  regionSelect.addEventListener("change", function() {
    const regionId = this.value;
    // Si no hay región seleccionada, mostrar todas las comunas
    if (!regionId) {
      comunaSelect.innerHTML = "";
      allComunas.forEach(opt => comunaSelect.appendChild(opt.cloneNode(true)));
      return;
    }
    // AJAX para obtener comunas de la región
    fetch(`/ajax/comunas/?region_id=${regionId}`)
      .then(response => response.json())
      .then(data => {
        comunaSelect.innerHTML = '<option value="">Comuna</option>';
        data.forEach(comuna => {
          const option = document.createElement("option");
          option.value = comuna.id;
          option.textContent = comuna.nombre;
          comunaSelect.appendChild(option);
        });
      });
  });

  // Si hay una región seleccionada al cargar, filtra las comunas
  if (regionSelect.value) {
    regionSelect.dispatchEvent(new Event("change"));
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
   setTimeout(function() {
    var messages = document.getElementById('messages');
    if (messages) {
      messages.style.display = 'none';
    }
   }, 5000); // 5000 ms = 5 segundos
  </script>
{% endblock %}